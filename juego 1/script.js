let temporizador;
let tiempoRestante = 1800; // 30 minutos
let juegoIniciado = false;
let verificarPresionado = 0;

const estructura = [
  ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "c", "u", "e", "n", "t", "a", "s", "p", "o", "r", "p", "a", "g", "a", "r", "a", "l", "a", "r", "g", "o", "p", "l", "a", "z", "o", "", "",],
  ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "n", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "", "", "h", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "t", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "", "", "i", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "g", "", "p", "r", "o", "v", "e", "e", "d", "o", "r", "e", "s", "", "", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "a", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "c", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "s", "", "t", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "a", "", "", "", "", "", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "t", "", "e", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "c", "", "", "", "", "", "", "b", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "o", "", "c", "", "", "i", "n", "t", "e", "r", "e", "s", "e", "s", "c", "o", "b", "r", "a", "d", "o", "s", "p", "o", "r", "a", "n", "t", "i", "c", "i", "p", "a", "d", "o", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "s", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "p", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "d", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "e", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "d", "", "", "", "", "", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "n", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "o", "", "", "", "", "", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "d", "", "r", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "r", "", "", "", "", "", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "i", "m", "p", "u", "e", "s", "t", "o", "s", "p", "e", "n", "d", "i", "e", "n", "t", "e", "s", "d", "e", "p", "a", "g", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "e", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "r", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "n", "", "g", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "d", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "t", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "i", "", "", "", "", "", "", "n", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "e", "", "r", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "v", "", "", "", "", "", "", "t", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "i", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "d", "o", "c", "u", "m", "e", "n", "t", "o", "s", "p", "o", "r", "p", "a", "g", "a", "r", "", "", "", "", "", "", "c", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "i", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "o", "", "", "", "", "", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "a", "n", "t", "i", "c", "i", "p", "o", "d", "e", "c", "l", "i", "e", "n", "t", "e", "s", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "g", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "d", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "d", "o", "c", "u", "m", "e", "n", "t", "o", "s", "p", "o", "r", "p", "a", "g", "a", "r", "a", "l", "a", "r", "g", "o", "p", "l", "a", "z", "o", "", "", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
  ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
 
];

const respuestas = [
    ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "c", "u", "e", "n", "t", "a", "s", "p", "o", "r", "p", "a", "g", "a", "r", "a", "l", "a", "r", "g", "o", "p", "l", "a", "z", "o", "", "",],
    ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "n", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "", "", "h", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "t", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "", "", "i", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "g", "", "p", "r", "o", "v", "e", "e", "d", "o", "r", "e", "s", "", "", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "a", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "c", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "s", "", "t", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "a", "", "", "", "", "", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "t", "", "e", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "c", "", "", "", "", "", "", "b", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "o", "", "c", "", "", "i", "n", "t", "e", "r", "e", "s", "e", "s", "c", "o", "b", "r", "a", "d", "o", "s", "p", "o", "r", "a", "n", "t", "i", "c", "i", "p", "a", "d", "o", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "s", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "p", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "d", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "e", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "d", "", "", "", "", "", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "n", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "o", "", "", "", "", "", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "d", "", "r", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "r", "", "", "", "", "", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "i", "m", "p", "u", "e", "s", "t", "o", "s", "p", "e", "n", "d", "i", "e", "n", "t", "e", "s", "d", "e", "p", "a", "g", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "e", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "r", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "n", "", "g", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "d", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "t", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "i", "", "", "", "", "", "", "n", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "e", "", "r", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "v", "", "", "", "", "", "", "t", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "i", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "d", "o", "c", "u", "m", "e", "n", "t", "o", "s", "p", "o", "r", "p", "a", "g", "a", "r", "", "", "", "", "", "", "c", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "e", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "s", "", "", "", "", "", "", "i", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "o", "", "", "", "", "", "", "p", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "a", "n", "t", "i", "c", "i", "p", "o", "d", "e", "c", "l", "i", "e", "n", "t", "e", "s", "", "", "", "", "", "", "a", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "g", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "d", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "d", "o", "c", "u", "m", "e", "n", "t", "o", "s", "p", "o", "r", "p", "a", "g", "a", "r", "a", "l", "a", "r", "g", "o", "p", "l", "a", "z", "o", "", "", "", "o", "", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
 
];

// NÃºmeros de pistas (fila-columna : nÃºmero)
const numerosPistas = {
// Horizontales
"7-12": 3,   // "cuentasporpagara..."
"17-10": 5,    // "proveedores"
"23-10": 6,   // "interesescobrados..."
"26-10": 7,   // "impuestospendientes..."
"28-2": 8,   // "anticipodeclientes"
"2-20": 9,    // "documentosporpagar..."
"11-15": 10, // intereces..."

// Verticales
"5-12": 1,    // "hipotecas" (h-i-p-o-t-e-c-a-s)
"7-10": 2,    // "gastos" (g-a-s-t-o-s)
"9-27": 4,    // "acreedores" (a-c-r-e-e-d-o-r-e-s)
"2-34": 11   // "anticipos" (a-n-t-i-c-i-p-o-s)
};

const tabla = document.getElementById("crucigrama");
let inputs = [];

estructura.forEach((fila, i) => {
  const tr = document.createElement("tr");
  let filaInputs = [];
  fila.forEach((celda, j) => {
    const td = document.createElement("td");
    td.style.position = "relative"; // Para que el numerito se posicione bien

    if (celda !== "") {
      const input = document.createElement("input");
      input.setAttribute("maxlength", 1);
      input.dataset.row = i;
      input.dataset.col = j;
      input.disabled = true;

      filaInputs.push(input);

      // Colocar el numerito si corresponde
      const key = `${i}-${j}`;
      if (numerosPistas[key]) {
        const numero = document.createElement("div");
        numero.textContent = numerosPistas[key];
        numero.style.position = "absolute";
        numero.style.top = "2px";
        numero.style.left = "4px";
        numero.style.fontSize = "8px";
        numero.style.fontWeight = "bold";
        numero.style.color = "#555";
        td.appendChild(numero);
      }

      td.appendChild(input);

      input.addEventListener("keydown", function (e) {
        if (e.key.length === 1 && !/[a-zÃ±]/i.test(e.key)) {
          e.preventDefault();
          return;
        }

        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
          e.preventDefault();
          navegarEntreCeldas(e.key, i, j);
        }

        if (e.key === "Enter") {
          verificarRespuestas();
        }

        if (e.key.length === 1 && /[a-zÃ±]/i.test(e.key)) {
          setTimeout(() => {
            const nextInput = document.querySelector(
              `input[data-row="${i}"][data-col="${j + 1}"]`
            );
            if (nextInput) nextInput.focus();
          }, 10);
        }
      });
    } else {
      
      filaInputs.push(null);
    }

    tr.appendChild(td);
  });
  inputs.push(filaInputs);
  tabla.appendChild(tr);
});

function navegarEntreCeldas(direccion, filaActual, colActual) {
  let nuevaFila = filaActual;
  let nuevaCol = colActual;

  switch (direccion) {
    case "ArrowUp": nuevaFila = Math.max(0, filaActual - 1); break;
    case "ArrowDown": nuevaFila = Math.min(estructura.length - 1, filaActual + 1); break;
    case "ArrowLeft": nuevaCol = Math.max(0, colActual - 1); break;
    case "ArrowRight": nuevaCol = Math.min(estructura[filaActual].length - 1, colActual + 1); break;
  }

  if (inputs[nuevaFila] && inputs[nuevaFila][nuevaCol]) {
    inputs[nuevaFila][nuevaCol].focus();
  }
}

function iniciarJuego() {
  if (juegoIniciado) return;
  juegoIniciado = true;
  verificarPresionado = 0;

  document.querySelectorAll("input").forEach(input => {
    input.disabled = false;
  });

  temporizador = setInterval(() => {
    if (tiempoRestante <= 0) {
      clearInterval(temporizador);
      verificarRespuestas(true);
      document.querySelectorAll("input").forEach(input => input.disabled = true);
    } else {
      tiempoRestante--;
      actualizarTemporizador();
    }
  }, 1000);
}

function actualizarTemporizador() {
  const minutos = Math.floor(tiempoRestante / 60).toString().padStart(2, "0");
  const segundos = (tiempoRestante % 60).toString().padStart(2, "0");
  document.getElementById("tiempo").textContent = `${minutos}:${segundos}`;
}

function verificarRespuestas(final = false) {
  verificarPresionado++;

  let correcto = true;
  let correctas = 0;
  const inputsLista = Array.from(document.querySelectorAll("input"));

  inputsLista.forEach(input => {
    const row = input.dataset.row;
    const col = input.dataset.col;
    const letra = input.value.toLowerCase();
    if (letra === respuestas[row][col]) {
      correctas++;
    } else {
      correcto = false;
    }
  });

  inputsLista.forEach(input => {
    const row = input.dataset.row;
    const col = input.dataset.col;
    const letra = input.value.toLowerCase();

    if (letra !== respuestas[row][col]) {
      input.classList.add("celda-incorrecta");
      input.classList.remove("celda-correcta");
    } else {
      input.classList.add("celda-correcta");
      input.classList.remove("celda-incorrecta");
    }
  });

  const mensaje = document.getElementById("mensaje");

  if (verificarPresionado >= 2 || final) {
    clearInterval(temporizador);
    document.querySelectorAll("input").forEach(input => input.disabled = true);
    mensaje.textContent = `âœ… Juego finalizado. Respuestas correctas: ${correctas}`;
    verificarPresionado = 0;
  } else {
    mensaje.textContent = correcto ? "ðŸŽ‰ Â¡Correcto!" : "âŒ Algunas respuestas estÃ¡n incorrectas. Vuelve a verificar para finalizar.";
  }
}

function reiniciarCrucigrama() {
  clearInterval(temporizador);
  juegoIniciado = false;
  tiempoRestante = 1800;
  verificarPresionado = 0;
  actualizarTemporizador();

  document.querySelectorAll("input").forEach(input => {
    input.value = "";
    input.classList.remove("celda-correcta", "celda-incorrecta");
    input.disabled = true;
  });

  document.getElementById("mensaje").textContent = "";
}

// Hacemos accesibles las funciones para el HTML
window.iniciarJuego = iniciarJuego;
window.verificarRespuestas = verificarRespuestas;
window.reiniciarCrucigrama = reiniciarCrucigrama;